{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://keep-starknet-strange.github.io/starknet-agentic/spec/signer-api-v1.schema.json",
  "title": "Starknet signer proxy API v1 payload schemas",
  "$comment": "Use $defs.signSessionTransactionRequest, $defs.signSessionTransactionResponse, and $defs.signerErrorResponse for strict validation.",
  "oneOf": [
    {
      "$ref": "#/$defs/signSessionTransactionRequest"
    },
    {
      "$ref": "#/$defs/signSessionTransactionResponse"
    },
    {
      "$ref": "#/$defs/signerErrorResponse"
    }
  ],
  "$defs": {
    "feltHex": {
      "type": "string",
      "pattern": "^0x[0-9a-fA-F]+$"
    },
    "signCall": {
      "type": "object",
      "additionalProperties": false,
      "required": ["contractAddress", "entrypoint", "calldata"],
      "properties": {
        "contractAddress": {
          "$ref": "#/$defs/feltHex"
        },
        "entrypoint": {
          "type": "string",
          "minLength": 1
        },
        "calldata": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/feltHex"
          }
        }
      }
    },
    "signContext": {
      "type": "object",
      "additionalProperties": false,
      "required": ["requester", "tool", "reason"],
      "properties": {
        "requester": {
          "type": "string",
          "minLength": 1
        },
        "tool": {
          "type": "string",
          "minLength": 1
        },
        "reason": {
          "type": "string",
          "minLength": 1
        },
        "actor": {
          "type": "string"
        },
        "traceId": {
          "type": "string"
        },
        "sessionId": {
          "type": "string"
        }
      }
    },
    "signSessionTransactionRequest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["accountAddress", "chainId", "nonce", "validUntil", "calls", "context"],
      "properties": {
        "accountAddress": {
          "$ref": "#/$defs/feltHex"
        },
        "keyId": {
          "type": "string",
          "minLength": 1
        },
        "chainId": {
          "$ref": "#/$defs/feltHex"
        },
        "nonce": {
          "$ref": "#/$defs/feltHex"
        },
        "validUntil": {
          "type": "integer",
          "minimum": 1
        },
        "calls": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/signCall"
          }
        },
        "context": {
          "$ref": "#/$defs/signContext"
        }
      }
    },
    "signSessionTransactionResponse": {
      "type": "object",
      "additionalProperties": false,
      "required": ["signature", "signatureMode", "signatureKind", "domainHash", "messageHash"],
      "properties": {
        "signature": {
          "type": "array",
          "minItems": 4,
          "maxItems": 4,
          "items": {
            "$ref": "#/$defs/feltHex"
          }
        },
        "signatureMode": {
          "type": "string",
          "const": "v2_snip12"
        },
        "signatureKind": {
          "type": "string",
          "const": "Snip12"
        },
        "signerProvider": {
          "type": "string",
          "enum": ["local", "dfns"]
        },
        "sessionPublicKey": {
          "$ref": "#/$defs/feltHex"
        },
        "domainHash": {
          "$ref": "#/$defs/feltHex"
        },
        "messageHash": {
          "$ref": "#/$defs/feltHex"
        },
        "requestId": {
          "type": "string"
        },
        "audit": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "policyDecision": {
              "type": "string",
              "enum": ["allow"]
            },
            "decidedAt": {
              "type": "string",
              "format": "date-time"
            },
            "keyId": {
              "type": "string"
            },
            "traceId": {
              "type": "string"
            }
          }
        }
      }
    },
    "signerErrorResponse": {
      "type": "object",
      "additionalProperties": false,
      "required": ["error", "errorCode", "requestId", "retryable"],
      "properties": {
        "error": {
          "type": "string"
        },
        "errorCode": {
          "type": "string",
          "enum": [
            "AUTH_INVALID_HMAC",
            "AUTH_INVALID_CLIENT",
            "AUTH_TIMESTAMP_SKEW",
            "AUTH_MTLS_REQUIRED",
            "REPLAY_NONCE_USED",
            "POLICY_SELECTOR_DENIED",
            "POLICY_CALL_NOT_ALLOWED",
            "RATE_LIMITED",
            "SIGNER_UNAVAILABLE",
            "INTERNAL_ERROR"
          ]
        },
        "requestId": {
          "type": "string"
        },
        "retryable": {
          "type": "boolean"
        }
      }
    }
  }
}
