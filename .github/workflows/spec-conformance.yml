name: Spec Conformance

on:
  pull_request:
    branches: [main]
    paths:
      - 'contracts/session-account/**'
      - 'packages/**'
      - 'spec/interop-version.json'
      - 'spec/interop-version.schema.json'
      - 'docs/**'
  push:
    branches: [main]
    paths:
      - 'contracts/session-account/**'
      - 'packages/**'
      - 'spec/interop-version.json'
      - 'spec/interop-version.schema.json'
      - 'docs/**'
  repository_dispatch:
    types: [spec-conformance-request]
  schedule:
    - cron: '40 5 * * *'
  workflow_dispatch:

concurrency:
  group: spec-conformance-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  SISNA_REPO: ${{ vars.SISNA_REPO }}

jobs:
  conformance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Validate local interop manifest (strict)
        run: |
          set -euo pipefail
          test -f spec/interop-version.schema.json
          jq -e '
            type == "object" and
            (keys | sort) == ["required_auth_headers","session_signature_envelope","signer_api_path","spec_version"] and
            (.spec_version | type == "string" and test("^[0-9]+\\.[0-9]+\\.[0-9]+$")) and
            .session_signature_envelope == "[session_pubkey,r,s,valid_until]" and
            .signer_api_path == "/v1/sign/session-transaction" and
            .required_auth_headers == ["X-Keyring-Timestamp","X-Keyring-Nonce","X-Keyring-Signature"]
          ' spec/interop-version.json >/dev/null
          jq -r '.spec_version' spec/interop-version.json

      - name: Clone counterpart repos
        run: |
          set -euo pipefail
          SISNA_TARGET="${SISNA_REPO:-omarespejel/SISNA}"
          git clone --depth 1 https://github.com/keep-starknet-strange/starkclaw.git /tmp/starkclaw
          git clone --depth 1 "https://github.com/${SISNA_TARGET}.git" /tmp/SISNA

      - name: Compare spec version across repos
        run: |
          set -euo pipefail
          LOCAL_VERSION=$(jq -r '.spec_version' spec/interop-version.json)
          STARKCLAW_VERSION=$(jq -r '.spec_version' /tmp/starkclaw/spec/interop-version.json)
          SISNA_VERSION=$(jq -r '.spec_version' /tmp/SISNA/spec/interop-version.json)
          echo "agentic=$LOCAL_VERSION starkclaw=$STARKCLAW_VERSION sisna=$SISNA_VERSION"
          test "$LOCAL_VERSION" = "$STARKCLAW_VERSION"
          test "$LOCAL_VERSION" = "$SISNA_VERSION"

      - name: Validate boundary invariants
        run: |
          set -euo pipefail
          rg -n "if signature\.len\(\) == 4" contracts/session-account/src/account.cairo
          rg -n "signature\.at\(3\)" contracts/session-account/src/account.cairo
          rg -n "parsed\.signature\.length !== 4" /tmp/starkclaw/apps/mobile/lib/signer/keyring-proxy-signer.ts
          rg -n "name: X-Keyring-Signature" /tmp/SISNA/docs/api-spec.yaml
          rg -n "validUntil:" /tmp/SISNA/docs/api-spec.yaml
          rg -n "/v1/sign/session-transaction:" /tmp/SISNA/docs/api-spec.yaml
